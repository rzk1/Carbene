&GLOBAL
  PROJECT TEST 
  RUN_TYPE CELL_OPT
  PRINT_LEVEL LOW 
&END GLOBAL

&MOTION
  &CELL_OPT
    CONSTRAINT Z
    MAX_ITER  100
    KEEP_ANGLES T
    EXTERNAL_PRESSURE 1
    PRESSURE_TOLERANCE 100
    KEEP_SYMMETRY T
  &END
&END MOTION

&FORCE_EVAL
  METHOD QS
  STRESS_TENSOR ANALYTICAL
  &DFT

    #&PRINT
    #  &PDOS
    #    NLUMO             -1
    #    FILENAME          ./pdos.raw
    #    COMPONENTS        TRUE
    #  &END PDOS
    #&END PRINT

    BASIS_SET_FILE_NAME BASIS_MOLOPT_COMBINED
    POTENTIAL_FILE_NAME GTH_POTENTIALS
    
    &QS
      METHOD GPW
      ALMO_SCF F ! ##ALMO##
      EPS_DEFAULT 1.0E-12 # overall accuracy of the Kohn-Sham matrix build
    &END QS
    
    &ALMO_SCF

      EPS_FILTER                 1.0E-11
      ALMO_ALGORITHM             SKIP
      ALMO_SCF_GUESS             ATOMIC
      MO_OVERLAP_INV_ALG         DENSE_CHOLESKY
      !XALMO_TRIAL_WF             PROJECT_R0_OUT
      XALMO_TRIAL_WF             SIMPLE
      DELOCALIZE_METHOD          XALMO_SCF
      XALMO_R_CUTOFF_FACTOR      1.8 ! ##RCUT##
      ALMO_EXTRAPOLATION_ORDER   4
      XALMO_EXTRAPOLATION_ORDER  4

      &MATRIX_ITERATE
        EPS_TARGET_FACTOR        10.
      &END MATRIX_ITERATE

      &ALMO_OPTIMIZER_DIIS
        MAX_ITER                 100
        EPS_ERROR                1.0E-5
        N_DIIS                   5
      &END ALMO_OPTIMIZER_DIIS
      
      &ALMO_OPTIMIZER_PCG
        MAX_ITER                 50
        EPS_ERROR                1.0E-5
        CONJUGATOR               DAI_YUAN
        LIN_SEARCH_EPS_ERROR     0.05
        LIN_SEARCH_STEP_SIZE_GUESS 0.005
        MAX_ITER_OUTER_LOOP      10
      &END ALMO_OPTIMIZER_PCG
      
      &XALMO_OPTIMIZER_PCG
        MAX_ITER                 1000
        EPS_ERROR                1.0E-5
        CONJUGATOR               DAI_YUAN
        LIN_SEARCH_EPS_ERROR     0.1
        LIN_SEARCH_STEP_SIZE_GUESS 0.01
        MAX_ITER_OUTER_LOOP      0
        PRECOND_FILTER_THRESHOLD 0.001
      &END XALMO_OPTIMIZER_PCG
      
    &END ALMO_SCF
    
    &MGRID
      CUTOFF 300
      NGRIDS 4
    &END MGRID

    &KPOINTS
       SCHEME  MONKHORST-PACK  4 4 1
       SYMMETRY FALSE
       EPS_GEO 1.e-8
       FULL_GRID TRUE
       VERBOSE TRUE
       PARALLEL_GROUP_SIZE  0
    &END KPOINTS

    &XC
      &XC_GRID 
         XC_SMOOTH_RHO NN10
         XC_DERIV SPLINE2_SMOOTH
      &END XC_GRID
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      &vdW_POTENTIAL
         DISPERSION_FUNCTIONAL PAIR_POTENTIAL
         &PAIR_POTENTIAL
            TYPE DFTD3
            CALCULATE_C9_TERM .TRUE.
            REFERENCE_C9_TERM .TRUE.
            LONG_RANGE_CORRECTION .FALSE.
            PARAMETER_FILE_NAME dftd3.dat
            VERBOSE_OUTPUT .FALSE.
            REFERENCE_FUNCTIONAL PBE
            R_CUTOFF [angstrom] 10.0
            EPS_CN 1.0E-6
         &END PAIR_POTENTIAL
      &END vdW_POTENTIAL
    &END XC
  
    !&SCF

    !  EPS_SCF 1.0E-6
    !  MAX_SCF 50
    !  &OUTER_SCF
    !    OPTIMIZER NONE
    !    EPS_SCF 1.0E-6
    !    MAX_SCF 10
    !  &END OUTER_SCF

    !  &OT
    !    PRECONDITIONER FULL_ALL
    !    #PRECONDITIONER FULL_SINGLE_INVERSE
    !    #PRECONDITIONER FULL_KINETIC
    !  &END OT

    !  &PRINT
    !    &RESTART OFF
    !      BACKUP_COPIES 1
    !      &EACH
    !        QS_SCF 0
    !        JUST_ENERGY 0
    !        MD 20
    !      &END EACH
    !    &END RESTART
    !  &END PRINT

    !&END SCF

    &SCF

      ADDED_MOS 20000
      EPS_SCF 1.0E-6
      SCF_GUESS ATOMIC
      MAX_SCF  500
      CHOLESKY INVERSE

      #&MIXING
      #    METHOD  PULAY_MIXING #DIRECT_P_MIXING
      #&END

      &DIAGONALIZATION
        ALGORITHM STANDARD
      &END DIAGONALIZATION

      !&SMEAR  ON
      !  METHOD FERMI_DIRAC
      !  ELECTRONIC_TEMPERATURE [K] 300
      !&END SMEAR

      &MIXING
        METHOD  BROYDEN_MIXING
        ALPHA   0.1
        BETA    1.5
        NBROYDEN  8
      &END

      &PRINT
        &RESTART OFF
        &END
      &END

    &END SCF

  &END DFT

  &SUBSYS

    &CELL
      A  3.186 0.0                 0.0 
      B -1.593 2.7591569364572215  0.0
      C  0.0   0.0                40.0  ! native bulk: 20.744
      MULTIPLE_UNIT_CELL 1 1 1 
    &END CELL

    &TOPOLOGY
      COORD_FILE_NAME 114-native.xyz
      COORDINATE XYZ
      !&GENERATE
      !  BONDLENGTH_MAX 1.0
      !  BONDPARM COVALENT
      !  BONDPARM_FACTOR 0.3
      !&END GENERATE
      MULTIPLE_UNIT_CELL 1 1 1
    &END
    
    &KIND N
      BASIS_SET TZV2P-MOLOPT-GTH
      POTENTIAL GTH-PBE-q5
      !&BS
      !  &ALPHA
      !    NEL -3 
      !    L    1
      !    N    5
      !  &END
      !  ! BETA FUNCTION SHOULD BE THE SAME
      !  ! TO AVOID WARNINGS
      !  &BETA
      !    NEL -3
      !    L    1
      !    N    5
      !  &END
      !&END
    &END KIND

    &KIND Ga
      BASIS_SET TZV2P-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q13
      !&BS
      !  &ALPHA
      !    NEL +2 
      !    L    1
      !    N    5
      !  &END
      !  ! BETA FUNCTION SHOULD BE THE SAME
      !  ! TO AVOID WARNINGS
      !  &BETA
      !    NEL +2
      !    L    1
      !    N    5
      !  &END
      !&END
    &END KIND

  &END SUBSYS

&END FORCE_EVAL

